% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/plot_hcp_intervals.R
\name{plot_hcp_intervals}
\alias{plot_hcp_intervals}
\title{Plot HCP prediction intervals (band vs covariate or intervals by patient)}
\usage{
plot_hcp_intervals(
  df,
  mode = c("band", "pid"),
  lo_col = "lo",
  hi_col = "hi",
  y_true_col = NULL,
  y_true = NULL,
  show_center = TRUE,
  show_true = TRUE,
  x_col = NULL,
  show_train = FALSE,
  max_train_patients = 30,
  pid_col = "pid",
  x_sort_col = NULL,
  max_patients = NULL,
  ...
)
}
\arguments{
\item{df}{A data.frame containing prediction results. It must include the interval
endpoints specified by \code{lo_col} and \code{hi_col}, and the covariate columns
required by the chosen plotting mode.}

\item{mode}{Plotting mode. Use \code{"band"} to visualize an interval band as a
function of a continuous covariate, or \code{"pid"} to visualize one prediction
interval per patient on the x-axis.}

\item{lo_col}{Name of the column containing the lower endpoint of the prediction
interval. Default is \code{"lo"}.}

\item{hi_col}{Name of the column containing the upper endpoint of the prediction
interval. Default is \code{"hi"}.}

\item{y_true_col}{Optional name of a column in \code{df} containing the true outcome
values. Used for overlaying truth points when \code{show_true = TRUE}.}

\item{y_true}{Optional numeric vector of true outcome values with length equal to
\code{nrow(df)}. If provided, this overrides \code{y_true_col}.}

\item{show_center}{Logical; if \code{TRUE}, draw the midpoint of each interval
(as a dashed line in \code{mode = "band"} or as points in \code{mode = "pid"}).}

\item{show_true}{Logical; if \code{TRUE}, overlay true outcome values when available.}

\item{x_col}{(mode = "band") Name of the covariate column used as the x-axis in the
interval band plot (e.g., time or another continuous predictor).}

\item{show_train}{(mode = "band") Logical; if \code{TRUE}, overlay a subset of training
trajectories ("spaghetti") from a data.frame named \code{dat_train} in the calling
environment. Training trajectories are drawn before the prediction band and may be
clipped by the plot y-limits.}

\item{max_train_patients}{(mode = "band") Maximum number of training patients/trajectories
to overlay when \code{show_train=TRUE}. Default is 30.}

\item{pid_col}{(mode = "pid") Name of the column identifying patients (or clusters).
Each patient must appear exactly once in \code{df}. Default is \code{"pid"}.}

\item{x_sort_col}{(mode = "pid") Optional covariate column used to order patients along
the x-axis (e.g., \code{"X1"}). If \code{NULL}, patients are ordered by their IDs.}

\item{max_patients}{(mode = "pid") Optional maximum number of patients to display.
If specified, only the first \code{max_patients} patients after sorting are plotted.}

\item{...}{Additional graphical parameters passed to \code{\link{plot}}, such as
\code{main}, \code{xlab}, \code{ylab}, \code{xlim}, or \code{ylim}.}
}
\value{
Invisibly returns the data.frame used for plotting:
\itemize{
\item For \code{mode = "band"}, the input \code{df} sorted by \code{x_col}.
\item For \code{mode = "pid"}, the input \code{df} sorted by \code{pid_col} or
\code{x_sort_col}, if provided.
}
}
\description{
Unified plotting function for two common visualizations of HCP prediction intervals:
\itemize{
\item \code{mode="band"}: plot an interval band (lo/hi) versus a 1D covariate (e.g., time X1).
Optionally overlay a subset of training trajectories ("spaghetti") before drawing the band.
\item \code{mode="pid"}: plot one interval per patient on the x-axis (patients optionally sorted by a covariate).
}

In \code{mode="band"}, if \code{show_train=TRUE}, this function looks for a
data.frame named \code{dat_train} in the calling environment and overlays up to
\code{max_train_patients} training trajectories using columns \code{id}, \code{x_col},
and \code{Y} (preferred) or \code{Y_full}. The y-axis limits are determined from the
prediction band (and optional truth), so training trajectories may be clipped.
}
\examples{
## ------------------------------------------------------------
## CD4 example
## ------------------------------------------------------------
## Load MACS CD4 data (lqmix::cd4)
if (!requireNamespace("lqmix", quietly = TRUE)) {
  stop("Package 'lqmix' is required for this example.")
}
data(cd4, package = "lqmix")

dat0 <- data.frame(
  id = cd4$sbj.id,
  X1 = cd4$time,
  X2 = cd4$age,
  X3 = cd4$packs,
  X4 = cd4$partners,
  X5 = cd4$drugs,
  X6 = cd4$cesd,
  Y_full = cd4$count
)
dat0 <- dat0[order(dat0$id, dat0$X1), ]
dat0$delta <- 1L; dat0$Y <- dat0$Y_full
x_cols <- sort(grep("^X\\\\d+$", names(dat0), value = TRUE))

yr <- range(dat0$Y_full, finite = TRUE)
pad <- 0.10 * diff(yr); if (!is.finite(pad) || pad <= 0) pad <- 50
y_grid <- seq(max(0, yr[1] - pad), yr[2] + pad, length.out = 201)

## Quick check: training trajectories
tr0 <- setNames(dat0[, c("id","X1","Y_full")], c("pid","X1","Y"))
plot(range(tr0$X1), range(tr0$Y),
     type = "n", xlab = "Time (X1)", ylab = "CD4 count",
     main = sprintf("Training trajectories (\%d subjects)", length(unique(tr0$pid))))
for (pp in unique(tr0$pid)) {
  ii <- which(tr0$pid == pp)
  if (length(ii) >= 2) lines(tr0$X1[ii], tr0$Y[ii], col = "grey70", lwd = 1)
}
legend("topright", bty = "n", legend = "Training trajectories", col = "grey70", lwd = 1)

## Case A: P=1, M>1 (band vs time for subjects)
for (pid in c(54, 92, 186)) {
  if (!any(dat0$id == pid)) next
  ## leave one out
  dat_test  <- dat0[dat0$id == pid, ]
  dat_train <- dat0[dat0$id != pid, ]
  x_test <- data.matrix(dat_test[, x_cols, drop = FALSE])

  res <- hcp_conformal_region(
    dat = dat_train,
    id_col = "id",
    y_col = "Y",
    delta_col = "delta",
    x_cols = x_cols,
    x_test = x_test,
    y_grid = y_grid,
    alpha = 0.1, S = 1, B = 1,
    dens_method = "rq",
    dens_taus = seq(0.05, 0.95, by = 0.01),
    seed = 1
  )
  pred <- data.frame(
    X1 = dat_test$X1,
    lo = pmax(as.numeric(res$lo_hi[, 1]), 0),
    hi = pmax(as.numeric(res$lo_hi[, 2]), 0),
    y_true = pmax(as.numeric(dat_test$Y_full), 0)
  )
  plot_hcp_intervals(
    pred, mode = "band", x_col = "X1",
    y_true_col = "y_true", show_true = TRUE,
main = sprintf("Case A: prediction band vs time: pid=\%s (M=\%d)", pid, nrow(pred))
  )
}

## Case B: random subjects; one time point per subject
set.seed(2)
idsB <- sample(unique(dat0$id), 20)
datB <- dat0[dat0$id \%in\% idsB, ]
datB <- datB[!duplicated(datB$id), ]  # earliest (dat0 already ordered)
x_testB <- data.matrix(datB[, x_cols, drop = FALSE])

resB <- hcp_conformal_region(
  dat = dat0[!(dat0$id \%in\% idsB), ],
  id_col = "id", y_col = "Y", delta_col = "delta",
  x_cols = x_cols, x_test = x_testB,
  y_grid = y_grid, alpha = 0.1, S = 1, B = 1,
  dens_method = "rq", dens_taus = seq(0.05, 0.95, by = 0.01), seed = 2
)
predB <- data.frame(pid = datB$id, X1 = datB$X1,
                    lo = pmax(as.numeric(resB$lo_hi[,1]), 0),
                    hi = pmax(as.numeric(resB$lo_hi[,2]), 0),
                    y_true = pmax(as.numeric(datB$Y_full), 0))
plot_hcp_intervals(predB, mode = "pid", pid_col = "pid", x_sort_col = "X1",
                   y_true_col = "y_true", show_true = TRUE,
                   main = "Case B: random subjects, one time point")
}
